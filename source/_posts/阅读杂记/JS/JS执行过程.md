---
title: JS执行过程
date: 2022-06-14 10:01:08
categories: 经验帖
tags:
    - JS基础
    - 杂记
summary: JS执行以代码段为单位,分为 三个阶段:语法分析 /创建阶段/ 执行阶段。作用域链是JS引擎查找变量的规则，原型链是JS引擎查找对象属性的规则
---

# JS执行过程

要了解JS的执行，首先要理解 __原型链__ __执行上下文__ __变量对象__  __作用域链__  __This__

__作用域链机制的意义__: JS查找 变量 的规则,会沿着作用域链[[scope]]向下查找

__原型链机制的意义__: JS查找 对象属性 的规则,会沿着原型链依次向上查找该属性.

__This机制的意义__: JS 为了在对象内部的方法中使用对象内部的属性(然后用到原型链) 的规则.

### 原型链

每一个JS对象在创建时都会与之关联一个对象，这个对象就是原型，每一个对象都会从原型"继承"属性。

[深入原型到原型链](https://luoziyu.cn/2021/02/07/javascript/shen-ru-js-xi-lie/1.cong-yuan-xing-dao-yuan-xing-lian/)

### 执行上下文（ES3时代）

__JS执行机制__: 以代码块为单位 先编译后执行，分为 __创建阶段__ 和 __执行阶段__.

("代码块"有三种:全局代码、函数代码、eval代码。)

__创建阶段__: 会生成两部分 __执行上下文__ 和 __可执行代码__

__执行上下文__: 是一段代码时的运行环境，包括执行期间要用到的 __变量对象__ / __作用域链__ / __This__

__执行上下文栈__: 用来管理这些执行上下文，是一个 先进后出的 栈结构.

__执行上下文栈__ 其实就是 JavaScript 引擎追踪函数执行的一个机制，和函数执行时的变量查找没什么关系

当一次有多个函数被调用时，通过调用栈就能够追踪到哪个函数正在被执行以及各函数之间的调用关系。

JS执行时首先会遇到全局代码，栈内压入 全局执行上下文.

然后执行到一个函数时，会 从 全局执行上下文 中取出这段函数的代码进行编译

创建该函数的执行上下文，又压入栈内.函数执行完毕，又弹出该执行上下文.

### 变量对象（ES3时代）

__变量对象__ / __作用域链__ / __This__,是执行上下文的三个重要属性

__变量对象__ 包含 当前上下文定义的 __形参(arguments)__ __函数声明__ __变量__ 的对象, 用于可执行代码执行时查找变变量，
在进入执行上下文时(创建阶段) 时创建

__全局对象(GO)__ 全局执行上下文 的 变量对象 就是 全局变量的宿主, 就是全局对象 其 window属性指向自己

__活动对象(AO)__ 函数执行上下文 的 变量对象.

变量对象 只是一个储存了所有变量的对象的概念

```js
function foo(a) {
  var b = 2;
  function c() {}
  var d = function() {};
  b = 3;
}
foo(1);

// AO = {
//     arguments: {
//         0: 1,
//         length: 1
//     },
//     a: 1,
//     b: undefined,
//     c: reference to function c(){},
//     d: undefined
// }
```

### 作用域链（ES3时代）

1. __作用域__: 其实就是 变量对象, 代表 函数和变量的可被访问的范围，生效范围.

变量存在于哪个 作用域 或 属于哪个变量对象,就可以在这个变量对象内被访问.

2. __作用域链__: 是JS查找变量的一套规则,本质上是由多个执行上下文的变量对象构成的链表,

链表的层级由 词法作用域 决定,查找变量时,会沿着作用域链查找.

3. 函数创建时的 __作用域链1__: 外层代码段编译时, 作为一个对象, 会产生一个内部属性 [[scope]],

并根据 词法作用域,从内到外层层将父代码段的 变量对象 保存其中.

4. __词法作用域__: 也是 __静态作用域__,JS的 作用域 由函数定义的位置决定,而不是执行时的 调用栈决定.

因为函数他所能引用的外部变量[[scope]],在函数创建的时候就已经决定了,而不是函数执行的时候

5. 函数调用时的 __作用域链2__: (进入自己的创建阶段,创建自己的执行上下文,压入执行上下文栈)

复制自己 [[scope]]属性 创建作用域链2, 创建自己的AO并初始化, 压入作用域链顶端.

### This（ES3时代）

当前可执行代码块的调用者

### JS执行（ES3时代）

JS是 __解释型语言__,边编译边执行.

JS执行 以 代码段 为单位,主要分为 三个阶段:__语法分析__ / __创建阶段__ / __执行阶段__

代码段 有三种: 全局代码 函数代码 eval代码

#### 第一步，语法分析

将代码分成 token,将 token解析成AST语法树(语法检查,报错)

分析该js脚本代码块的语法是否正确，

如果语法不正确，则抛出一个语法错误，停止该代码块的执行，然后继续查找并加载下一个代码块

如果语法正确，则进入创建阶段。

#### 第二步，创建阶段

##### 创建执行上下文，压入执行上下文栈

每进入一个 代码段, 或者说函数被调用时,便会创建相应的 __执行上下文__, 压入 __执行上下文栈__

##### 初始化执行上下文

主要初始化 执行上下文 的三个重要属性, __变量对象(Variable object)__ __作用域链(Outer)__ __This__

__作用域链（Scope Chain__

复制函数 [[scope]] 属性创建作用域链

> 注意是复制而不是修改,因为函数可能被多次调用,应当保证每次调用时,变量初始状态相同

__变量对象（Variable Object）__

依次检查 形参(Arguments对象) 函数声明 var声明变量(已有同名函数声明则跳过) 加入 VO

将 活动对象 压入 作用域链 顶端

此时的 VO 不能被直接访问，只有进入执行阶段，成为 活动对象（Active Object） 才能被访问。
__This__

#### 第三步，执行阶段

S 代码开始逐条执行，在这个阶段，JS 引擎开始对定义的变量赋值、开始顺着作用域链访问变量，

如果内部有函数调用就创建一个新的执行上下文压入执行栈并把控制权交出

#### 第四步，销毁阶段

当前执行上下文（局部环境）会被弹出执行上下文栈并且销毁，控制权被重新交给执行栈上一层的执行上下文

### ES5时代



| 变量类型   | 是否创建 | 是否初始化 | 是否赋值   |
| --------- | -------- | --------- | --------- |
| 形参       | 创建     | 初始化    | 并赋值实参 |
| 函数声明   | 创建     | 初始化    | 并赋值函数体|
| var变量    | 创建     | 初始化    |           |
| let/const |  创建    |           |           |

let/const 创建了但是没有初始化,所以在赋值前被调用即报错 未初始化，__暂时性死区__

### 感谢

看了二十多篇文章,都把我看懵了...

ES5时代

[面试官：说说执行上下文吧](https://juejin.cn/post/6844904158957404167#comment)

[JS夯实之执行上下文与词法环境](https://juejin.cn/post/6844904145372053511#heading-4)

[彻底搞懂作用域、执行上下文、词法环境](https://juejin.cn/post/7043408377661095967#heading-6)

[[译] 理解 JavaScript 中的执行上下文和执行栈](https://juejin.cn/post/6844903682283143181)

ES3时代文章

[冴羽 JavaScript深入之执行上下文](https://github.com/mqyqingfeng/Blog/issues/8)

[李兵《浏览器工作原理与实践》浏览器中的JavaScript执行机制](https://time.geekbang.org/column/article/119046)


